<!doctype html>
<html>
 <head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
  <title>pdb->mmcif or mtz->mmcif</title>
  <style>
   html { background-color: #f8f8f8; color: #111; }
   body { font-family: sans-serif; line-height: 1.6; padding: 5px 15px; }
   textarea {
    line-height: 1.5;
    padding: 10px;
    border-radius: 5px;
    border: 1px solid #bbb;
    box-shadow: 1px 1px 1px #888;
  }
  </style>
 </head>
 <body>
  <p>
  This page (web app) converts PDB and MTZ files to mmCIF inside your web browser.<br>
  Once this page is loaded, no server is contacted.<br>
  Requires not too old browser (from 2018 or later).
  </p>
  <form>
   <p>
    To start, select either PDB or MTZ file from disk.
    <input id="fileInput" type="file" multiple onchange="read_file()" disabled>
    <br/>
    <small>To convert two MTZ files (merged and unmerged) together,
           press Ctrl to select two files.</small>
   </p>
  </form>
  <textarea class="emscripten" id="output" rows="8" cols="72"></textarea>
  <p id="message" hidden>
  Done! <a id="link">Download CIF</a>.
  </p>
  <script type='text/javascript'>
  var fileInput = document.getElementById('fileInput');
  var message = document.getElementById('message');
  var link = document.getElementById('link');
  var element = document.getElementById('output');

  var Module = {
    print: function(text) {
      console.log(text);
      element.value += text + '\n';
      element.scrollTop = element.scrollHeight; // focus on bottom
    },
    setStatus: function(text) {
      Module.print(text);
      if (text === '') fileInput.disabled = false;
    },
    onRuntimeInitialized: function() {
      var version = Module.ccall('get_version', 'string', [], []);
      Module.print('Powered by GEMMI v' + version + '.\n');
    }
  };
  Module['printErr'] = Module['print'];

  Module.print('Downloading the converter...');
  window.onerror = function() {
    Module.print('Exception thrown, see JavaScript console');
  };

  function read_file() {
    var start = new Date();
    message.hidden = true;
    if (!fileInput || fileInput.files.length === 0) return;
    var f = fileInput.files[0];
    var f2 = null;
    var is_mtz = f.name.toLowerCase().endsWith('.mtz');
    if (is_mtz && fileInput.files.length === 2) {
      f2 = fileInput.files[1];
      Module.print('Converting MTZ files ' + f.name + ' (' + f.size + ' bytes) and ' +
                   f2.name + ' (' + f2.size + ' bytes)...');
    } else if (fileInput.files.length > 1) {
      Module.print('Two many files selected. Try again.')
      return;
    } else {
      Module.print('Converting ' + (is_mtz ? 'MTZ' : 'PDB') + ' file ' + f.name +
                   ' (' + f.size + ' bytes)...');
    }
    var reader = new FileReader();
    var reader2 = null;
    var args = null;
    if (f2) {
      reader2 = new FileReader();
      reader2.onload = function(evt) {
        var arr = new Uint8Array(evt.target.result);
        var buffer = Module._malloc(arr.length);
        Module.writeArrayToMemory(arr, buffer);
        args.push(buffer);
        args.push(arr.length);
        var cif_str = Module.ccall('mtzpair2cif', 'string',
                                   ['number', 'number', 'number', 'number'], args);
        var validation_str = Module.ccall('get_str2', 'string', [], []);
        Module.print('Comparing the two input files.\n' + validation_str);
        finalize(cif_str);
      }
    }
    reader.onload = function(evt) {
      var arr = new Uint8Array(evt.target.result);
      var buffer = Module._malloc(arr.length);  // to be free'd by pdb2cif
      Module.writeArrayToMemory(arr, buffer);
      args = [buffer, arr.length];
      if (f2) {
        reader2.readAsArrayBuffer(f2);
        return;
      }
      var cif_str = Module.ccall(is_mtz ? 'mtz2cif' : 'pdb2cif',
                                 'string', ['number', 'number'], args);
      finalize(cif_str);
    };
    function finalize(cif_str) {
      Module.ccall('clear_string', null, [], []);
      if (cif_str[0] == 'E') {
        Module.print(cif_str);
        return;
      }
      Module.print('Resulting mmCIF file has ' + cif_str.length + ' bytes.');
      var now = new Date();
      var mb = Math.round(HEAP8.length / (1024 * 102.4)) / 10;
      Module.print((now - start) + ' ms elapsed. WASM memory: ' + mb + ' MB.\n');
      link.download = f.name.substr(0, f.name.lastIndexOf('.')) + '.cif';
      var blob = new Blob([cif_str], {type: 'text/plain'});
      link.href = window.URL.createObjectURL(blob);
      message.hidden = false;
      //link.click();
    }
    reader.readAsArrayBuffer(f);
  }
  </script>
  <script type="text/javascript" src="pdb2cif.js"></script>
 </body>
</html>
